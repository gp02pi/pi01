{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cadastro de Clientes</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
* {margin: 0;padding: 0;box-sizing: border-box;}
body {font-family: 'Arial', sans-serif;background-color: #f4f6f9;display: flex;justify-content: center;align-items: flex-start;min-height: 120vh;padding-top: 100px;}
.container {background-color: #fff;padding: 30px;border-radius: 8px;width: 100%;max-width: 1200px;display: flex;gap: 20px;margin: 220px auto 0;flex-wrap: wrap;}
.form-container,.client-list {flex: 1;padding: 20px;border-radius: 8px;background-color: #fff;box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);}
h2 {font-size: 28px;margin-bottom: 20px;text-align: center;color: #2c3e50;}
label {font-size: 14px;font-weight: 600;color: #7f8c8d;margin-bottom: 8px;display: block;}
input,button {width: 100%;padding: 14px;margin-bottom: 10px;border-radius: 8px;border: 1px solid #ccc;font-size: 16px;outline: none;transition: border-color 0.3s ease;}
input:focus {border-color: #26A0B8;}
button {background-color: #26A0B8;color: white;font-weight: bold;border: none;cursor: pointer;transition: background-color 0.3s ease;}
button:hover {background-color: #1f7f92;}
.msg {font-size: 12px;color: #888;margin-bottom: 10px;display: block;}
.error-msg {font-size: 12px;color: red;margin-bottom: 10px;display: block;min-height: 15px;}
.client-list {max-height: 400px;overflow-y: auto;}
.client-list h3 {font-size: 24px;margin-bottom: 20px;color: #2c3e50;text-align: center;}
.client-list ul {list-style-type: none;padding: 0;}
.client-list ul li {background-color: #ecf0f1;border-radius: 6px;padding: 15px;margin-bottom: 10px;box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);transition: background-color 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;position: relative;word-wrap: break-word;word-break: break-word;}
.client-list ul li:hover {background-color: #bdc3c7;}
.client-list ul li strong {font-size: 16px;color: #0f0f0f;display: block;margin-bottom: 8px;}
.client-list ul li span {font-size: 14px;color: #303030da;display: block;margin-bottom: 1px;}
.client-list ul li span.label {font-weight: 600;color: #242323ee;}
.filter-container {margin-bottom: 20px;}
#searchInput {padding: 12px;width: 100%;}
.client-list li .detail-item {display: flex;align-items: center;gap: 8px;margin-bottom: 10px;}
.client-list li .detail-item .label {font-weight: 600;white-space: nowrap;}
.action-icons {position: absolute;top: 10px;right: 10px;display: flex;gap: 10px;z-index: 10;}
.action-icons i {cursor: pointer;font-size: 16px;}
.action-icons i.edit {color: #696868;}
.action-icons i.edit:hover {color: #4d4d4d;}
.action-icons i.delete {color: #E74C3C;}
.action-icons i.delete:hover {color: #C0392B;}
.client-list li.editing {background-color: #f8f9fa;box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);border: 1px solid #26A0B8;}
.client-list li.editing .client-details,.client-list li.editing .action-icons {display: none;}
.client-list li.editing .edit-form-container {display: block;}
.edit-form-container {display: none;}
.edit-form-container form {display: flex;flex-direction: column;gap: 10px;}
.edit-form-container .edit-field {display: flex;align-items: center;gap: 10px;}
.edit-form-container .edit-field label {width: 100px;flex-shrink: 0;}
.edit-form-container input {padding: 8px;font-size: 14px;margin-bottom: 0;flex-grow: 1;}
.edit-buttons {display: flex;gap: 10px;justify-content: flex-end;margin-top: 10px;}
.edit-buttons button {width: auto;padding: 8px 15px;border-radius: 4px;}
.edit-buttons .save {background-color: #26A0B8;}
.edit-buttons .cancel {background-color: #e74c3c;}
.edit-buttons .save:hover {background-color: #1f7f92;}
.edit-buttons .cancel:hover {background-color: #c0392b;}
/* Estilos do Pop-up Minimalista */
.popup-msg{position:fixed;top:20px;right:20px;display:flex;align-items:center;color:white;padding:12px 20px;font-size:15px;border-radius:6px;box-shadow:0 3px 10px rgba(0,0,0,0.15);min-width:250px;max-width:350px;z-index:1002;opacity:0;transform:translateX(calc(100% + 30px));transition:opacity 0.4s ease,transform 0.4s ease}
.popup-msg.show{opacity:1;transform:translateX(0)}
.popup-msg i{margin-right:12px;font-size:18px}
.modal-overlay {position: fixed;top: 0;left: 0;width: 100%;height: 100%;background-color: rgba(0, 0, 0, 0.6);display: none;justify-content: center;align-items: flex-start;padding-top: 100px;z-index: 1000;}
.modal-content {background-color: #fff;padding: 25px;border-radius: 8px;box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);width: 90%;max-width: 450px;animation: fadeIn 0.3s ease-out;}
.modal-header {display: flex;justify-content: space-between;align-items: center;border-bottom: 1px solid #ddd;padding-bottom: 15px;margin-bottom: 15px;}
.modal-header h3 {margin: 0;font-size: 22px;color: #333;}
.close-button {cursor: pointer;font-size: 24px;font-weight: bold;color: #888;transition: color 0.2s;}
.close-button:hover {color: #333;}
.modal-body {line-height: 1.6;margin-bottom: 20px;}
.modal-body p {font-size: 16px;color: #555;margin-bottom: 10px;}
.modal-footer {display: flex;justify-content: flex-end;gap: 10px;}
.btn {padding: 10px 20px;border: none;border-radius: 5px;cursor: pointer;font-weight: bold;transition: background-color 0.2s, transform 0.1s;}
.btn:hover {transform: translateY(-1px);}
.btn-cancel {background-color: #bdc3c7;color: #333;}
.btn-cancel:hover {background-color: #aeb5b9;}
.btn-delete {background-color: #e74c3c;color: #fff;}
.btn-delete:hover {background-color: #c0392b;}
@keyframes fadeIn {from {opacity: 0;transform: translateY(-20px);}to {opacity: 1;transform: translateY(0);}}
input[readonly] {background-color: #e9ecef;cursor: not-allowed;}
</style>
</head>
<body>
{% include 'barra.html' %}
{% include 'session_timeout_modal.html' %}
<div class="container">
<div class="form-container">
<h2>Cadastro de Clientes</h2>
<form id="clientForm">
<label for="name">Nome Completo:</label>
<input type="text" id="name" placeholder="Nome do cliente" required>
<label for="cpf">CPF:</label>
<input type="text" id="cpf" placeholder="000.000.000-00" required>
<label for="email">E-mail:</label>
<input type="email" id="email" placeholder="exemplo@cliente.com" required>
<label for="phone">Telefone:</label>
<input type="text" id="phone" placeholder="Digite apenas números" required>
<label for="cep">CEP:</label>
<input type="text" id="cep" placeholder="00000-000" required>
<label for="street">Rua/N°/Bairro:</label>
<input type="text" id="street" placeholder="Rua Exemplo, 123 - Bairro" required>
<label for="city">Cidade:</label>
<input type="text" id="city" placeholder="Preenchimento automático" required readonly>
<label for="state">Estado:</label>
<input type="text" id="state" placeholder="Preenchimento automático" required readonly>
<button type="submit">Cadastrar</button>
</form>
</div>
<div class="client-list" id="clientListContainer">
<h3>Clientes Cadastrados</h3>
<div class="filter-container">
<input type="text" id="searchInput" placeholder="Pesquisar cliente...">
</div>
<ul id="list"></ul>
</div>
</div>
<div class="popup-msg" id="popupMsg"></div>
<div id="deleteModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Confirmar Exclusão</h3>
            <span class="close-button">&times;</span>
        </div>
        <div class="modal-body">
            <p>Você tem certeza de que deseja excluir o cliente <strong><span id="clientNameToDelete"></span></strong>?</p>
            <p>Esta ação não pode ser desfeita.</p>
        </div>
        <div class="modal-footer">
            <button id="cancelDeleteBtn" class="btn btn-cancel">Cancelar</button>
            <button id="confirmDeleteBtn" class="btn btn-delete">Excluir</button>
        </div>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('clientForm');
    const list = document.getElementById('list');
    const searchInput = document.getElementById('searchInput');
    const cpfInput = document.getElementById('cpf');
    const phoneInput = document.getElementById('phone');
    const cepInput = document.getElementById('cep');
    const popupMsg = document.getElementById('popupMsg');
    
    const deleteModal = document.getElementById('deleteModal');
    const clientNameToDelete = document.getElementById('clientNameToDelete');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
    const closeDeleteModalBtn = deleteModal.querySelector('.close-button');
    let clientCpfToDelete = null;

    function openDeleteModal(cpf, name) {
        clientCpfToDelete = cpf;
        clientNameToDelete.textContent = name;
        deleteModal.style.display = 'flex';
    }

    function closeDeleteModal() {
        deleteModal.style.display = 'none';
        clientCpfToDelete = null;
    }

    confirmDeleteBtn.addEventListener('click', () => {
        if (clientCpfToDelete) {
            performDelete(clientCpfToDelete);
        }
        closeDeleteModal();
    });

    cancelDeleteBtn.addEventListener('click', closeDeleteModal);
    closeDeleteModalBtn.addEventListener('click', closeDeleteModal);
    deleteModal.addEventListener('click', (event) => {
        if (event.target === deleteModal) {
            closeDeleteModal();
        }
    });

    let clients = [];
    let editingLi = null;
    const API_URL = '/api/clientes/';

    function formatCEP(cep) {
        if (!cep) return "";
        return cep.replace(/\D/g, '').slice(0, 8).replace(/(\d{5})(\d)/, '$1-$2');
    }

    function formatCPF(cpf) {
        if (!cpf) return '';
        return cpf.replace(/\D/g, '').slice(0, 11).replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d{1,2})$/, '$1-$2');
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // --- FUNÇÃO DE POP-UP ATUALIZADA ---
    function showPopup(message, isError = false) {
        const icon = isError 
            ? '<i class="fas fa-times-circle"></i>' 
            : '<i class="fas fa-check-circle"></i>';
        
        popupMsg.innerHTML = `${icon} ${message}`;
        popupMsg.style.backgroundColor = isError ? '#e74c3c' : '#2ecc71';
        
        popupMsg.classList.add('show');
        
        setTimeout(() => {
            popupMsg.classList.remove('show');
        }, 3500);
    }
    
    function toggleAddressFields(formContainer, enableManual) {
        const cityField = formContainer.querySelector('[id^="city"], [data-field="cidade"]');
        const stateField = formContainer.querySelector('[id^="state"], [data-field="estado"]');

        cityField.readOnly = !enableManual;
        stateField.readOnly = !enableManual;

        if (enableManual) {
            cityField.placeholder = 'Digite a cidade';
            stateField.placeholder = 'Digite o estado (UF)';
        } else {
            cityField.placeholder = 'Preenchimento automático';
            stateField.placeholder = 'Preenchimento automático';
        }
    }

    async function handleCepLookup(event) {
        const inputElement = event.target;
        const formContainer = inputElement.closest('form');
        if (!formContainer) return;

        const streetField = formContainer.querySelector('[id^="street"], [data-field="endereco"]');
        const cityField = formContainer.querySelector('[id^="city"], [data-field="cidade"]');
        const stateField = formContainer.querySelector('[id^="state"], [data-field="estado"]');
        const cep = inputElement.value.replace(/\D/g, '');

        if (cep.length === 8) {
            try {
                const response = await fetch(`/api/buscar_cep/${cep}/`);
                if (!response.ok) throw new Error('CEP não encontrado');
                const data = await response.json();
                if (data.success) {
                    streetField.value = data.endereco;
                    cityField.value = data.cidade;
                    stateField.value = data.estado;
                    toggleAddressFields(formContainer, false);
                } else {
                    showPopup('CEP não encontrado. Preencha o endereço manualmente.', true);
                    streetField.value = ''; cityField.value = ''; stateField.value = '';
                    toggleAddressFields(formContainer, true);
                }
            } catch (error) {
                console.error("Erro na busca de CEP:", error);
                showPopup('Erro ao buscar CEP. Preencha o endereço manualmente.', true);
                streetField.value = ''; cityField.value = ''; stateField.value = '';
                toggleAddressFields(formContainer, true);
            }
        }
    }

    cpfInput.addEventListener('input', (e) => e.target.value = formatCPF(e.target.value));
    phoneInput.addEventListener('input', (e) => e.target.value = e.target.value.replace(/\D/g, ''));
    cepInput.addEventListener('input', (e) => e.target.value = formatCEP(e.target.value));
    cepInput.addEventListener('blur', handleCepLookup);

    form.addEventListener('submit', async function(event) {
        event.preventDefault();

        const clientData = {
            nome: document.getElementById('name').value.trim(),
            cpf: cpfInput.value.replace(/\D/g, ''),
            email: document.getElementById('email').value.trim(),
            telefone: phoneInput.value.replace(/\D/g, ''),
            cep: cepInput.value.replace(/\D/g, ''),
            endereco: document.getElementById('street').value.trim(),
            cidade: document.getElementById('city').value.trim(),
            estado: document.getElementById('state').value.trim()
        };

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                body: JSON.stringify(clientData),
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error || 'Erro desconhecido');

            showPopup('Cliente cadastrado com sucesso!');
            form.reset();
            toggleAddressFields(form, false);
            fetchClients();
        } catch (error) {
            showPopup(error.message, true);
        }
    });

    list.addEventListener('click', function(event) {
        const target = event.target;
        const li = target.closest('li[data-cpf]');
        if (!li) return;
        
        const cpf = li.dataset.cpf;
        const client = clients.find(c => c.cpf === cpf);

        if (target.matches('.edit, .edit *')) {
            startEdit(li, client);
        } else if (target.matches('.delete, .delete *')) {
            openDeleteModal(cpf, client.nome);
        } else if (target.matches('.save, .save *')) {
            saveChanges(cpf, li);
        } else if (target.matches('.cancel, .cancel *')) {
            cancelEdit(li);
        }
    });
    
    async function fetchClients() {
        try {
            const response = await fetch(API_URL);
            if (!response.ok) throw new Error('Erro ao carregar clientes.');
            clients = await response.json();
            renderList(clients);
        } catch (error) {
            console.error("Erro:", error);
            list.innerHTML = `<li><strong style="color: red;">${error.message}</strong></li>`;
        }
    }

    function renderList(items) {
        list.innerHTML = '';
        if (items.length === 0) {
            list.innerHTML = '<li>Nenhum cliente encontrado.</li>';
            return;
        }
        items.forEach(client => {
            const li = document.createElement('li');
            li.dataset.cpf = client.cpf;
            li.innerHTML = createClientCardHTML(client);
            list.appendChild(li);
        });
    }

    function createClientCardHTML(client) {
        return `
            <div class="client-details">
                <div class="detail-item"><span class="label">Nome:</span><span>${client.nome}</span></div>
                <div class="detail-item"><span class="label">CPF:</span><span>${formatCPF(client.cpf)}</span></div>
                <div class="detail-item"><span class="label">E-mail:</span><span>${client.email}</span></div>
                <div class="detail-item"><span class="label">Telefone:</span><span>${client.telefone}</span></div>
                <div class="detail-item"><span class="label">Endereço:</span><span>${client.endereco}, ${client.cidade} - ${client.estado}, CEP: ${formatCEP(client.cep)}</span></div>
            </div>
            <div class="action-icons">
                <i class="fas fa-edit edit" title="Editar"></i>
                <i class="fas fa-trash delete" title="Excluir"></i>
            </div>
            <div class="edit-form-container"></div>
        `;
    }

    function startEdit(li, client) {
        if (editingLi) cancelEdit(editingLi);
        editingLi = li;
        li.classList.add('editing');
        li.querySelector('.edit-form-container').innerHTML = `
            <form>
                <div class="edit-field"><label>Nome:</label><input type="text" data-field="nome" value="${client.nome}"></div>
                <div class="edit-field"><label>Email:</label><input type="email" data-field="email" value="${client.email}"></div>
                <div class="edit-field"><label>Telefone:</label><input type="text" data-field="telefone" value="${client.telefone}"></div>
                <div class="edit-field"><label>CEP:</label><input type="text" data-field="cep" value="${formatCEP(client.cep)}"></div>
                <div class="edit-field"><label>Endereço:</label><input type="text" data-field="endereco" value="${client.endereco}"></div>
                <div class="edit-field"><label>Cidade:</label><input type="text" data-field="cidade" value="${client.cidade}" readonly></div>
                <div class="edit-field"><label>Estado:</label><input type="text" data-field="estado" value="${client.estado}" readonly></div>
                <div class="edit-buttons">
                    <button type="button" class="save"><i class="fas fa-check"></i> Salvar</button>
                    <button type="button" class="cancel"><i class="fas fa-times"></i> Cancelar</button>
                </div>
            </form>
        `;
        const cepEditInput = li.querySelector('[data-field="cep"]');
        cepEditInput.addEventListener('input', (e) => e.target.value = formatCEP(e.target.value));
        cepEditInput.addEventListener('blur', handleCepLookup);
        li.querySelector('[data-field="telefone"]').addEventListener('input', (e) => e.target.value = e.target.value.replace(/\D/g, ''));
    }

    function cancelEdit(li) {
        li.classList.remove('editing');
        li.querySelector('.edit-form-container').innerHTML = '';
        editingLi = null;
    }

    async function saveChanges(cpf, li) {
        const updatedData = {
            nome: li.querySelector('[data-field="nome"]').value.trim(),
            email: li.querySelector('[data-field="email"]').value.trim(),
            telefone: li.querySelector('[data-field="telefone"]').value.replace(/\D/g, ''),
            cep: li.querySelector('[data-field="cep"]').value.replace(/\D/g, ''),
            endereco: li.querySelector('[data-field="endereco"]').value.trim(),
            cidade: li.querySelector('[data-field="cidade"]').value.trim(),
            estado: li.querySelector('[data-field="estado"]').value.trim()
        };

        try {
            const response = await fetch(`${API_URL}${cpf}/`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                body: JSON.stringify(updatedData),
            });
            if (!response.ok) throw new Error((await response.json()).error || 'Erro ao salvar.');
            showPopup('Cliente atualizado com sucesso!');
            fetchClients();
        } catch (error) {
            showPopup(`Erro: ${error.message}.`, true);
            cancelEdit(li);
        }
    }
    
    async function performDelete(cpf) {
        try {
            const response = await fetch(`${API_URL}${cpf}/`, {
                method: 'DELETE',
                headers: { 'X-CSRFToken': getCookie('csrftoken') }
            });
            if (response.status !== 204) {
                 const result = await response.json();
                 throw new Error(result.error || 'Erro ao excluir.');
            }
            showPopup('Cliente excluído com sucesso!');
            fetchClients();
        } catch (error) {
            showPopup(`Erro ao excluir: ${error.message}`, true);
        }
    }

    searchInput.addEventListener('input', () => {
        const searchTerm = searchInput.value.toLowerCase();
        const filtered = clients.filter(c => 
            c.nome.toLowerCase().includes(searchTerm) || 
            c.cpf.includes(searchTerm)
        );
        renderList(filtered);
    });
    
    fetchClients();
});
</script>
</body>
</html>