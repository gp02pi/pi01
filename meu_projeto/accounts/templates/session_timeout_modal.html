{% comment %}
MODAL DE REAUTENTICAÇÃO - VERSÃO COM DESIGN APRIMORADO E MENSAGEM DE ERRO CLARA
{% endcomment %}

{% if user.is_authenticated and session_timeout_seconds %}
<style>
/* CSS do Novo Modal (sem indentação, como solicitado) */
.timeout-modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(25,30,40,.7);display:flex;justify-content:center;align-items:center;z-index:9999;opacity:0;visibility:hidden;transition:opacity .3s ease,visibility .3s ease}.timeout-modal-overlay.active{opacity:1;visibility:visible}.timeout-modal-content{background-color:#fff;border-radius:16px;text-align:center;width:90%;max-width:400px;box-shadow:0 15px 50px rgba(0,0,0,.25);transform:translateY(20px);transition:transform .4s ease,opacity .4s ease;opacity:0}.timeout-modal-overlay.active .timeout-modal-content{transform:translateY(0);opacity:1}.timeout-modal-header{background-color:#26A0B8;border-radius:16px 16px 0 0;padding:25px;margin-bottom:20px}.timeout-modal-icon{width:70px;height:70px;margin:-75px auto 20px;background-color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:2.5rem;color:#26A0B8;box-shadow:0 8px 20px rgba(0,0,0,.1)}.timeout-modal-body{padding:0 35px 35px}.timeout-modal-body h2{font-size:1.5rem;font-weight:600;color:#333;margin-bottom:12px}.timeout-modal-body p{font-size:.95rem;color:#777;line-height:1.6;margin-bottom:25px}#reauth-form{display:flex;flex-direction:column;gap:15px}#reauth-password{width:100%;padding:14px 20px;border:1px solid #e0e0e0;background-color:#f9f9f9;border-radius:8px;font-size:1rem;text-align:center;transition:all .2s ease}#reauth-password:focus{border-color:#26A0B8;outline:none;background-color:#fff;box-shadow:0 0 0 4px rgba(38,160,184,.2)}.reauth-error-message{color:#e74c3c;font-size:.9rem;min-height:20px;text-align:center;display:none;font-weight:500;animation:shake .5s ease-in-out}@keyframes shake{0%,100%{transform:translateX(0)}10%,30%,50%,70%,90%{transform:translateX(-8px)}20%,40%,60%,80%{transform:translateX(8px)}}.timeout-modal-buttons{display:flex;gap:15px;justify-content:center;margin-top:20px}.timeout-modal-btn{padding:14px 25px;border:none;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer;transition:all .3s ease;width:100%}.btn-confirm-reauth{background-color:#26A0B8;color:white}.btn-confirm-reauth:hover{background-color:#1f7f92;box-shadow:0 4px 15px rgba(38,160,184,.3)}.btn-confirm-reauth:disabled{background-color:#b0bec5;cursor:not-allowed}.btn-confirm-reauth .btn-spinner{display:none;font-size:.9em}.btn-logout-reauth{background-color:transparent;color:#aaa;padding:0;font-size:.9rem;text-decoration:underline}.btn-logout-reauth:hover{color:#333}
</style>

<div id="session-timeout-modal-overlay" class="timeout-modal-overlay">
    <div class="timeout-modal-content">
        <div class="timeout-modal-header"></div>
        <div class="timeout-modal-icon">
            <i class="fas fa-lock"></i>
        </div>
        <div class="timeout-modal-body">
            <h2>Sessão Expirou</h2>
            <p>Para sua segurança, por favor, insira sua senha para continuar.</p>
            
            <form id="reauth-form" onsubmit="handleReauthentication(event)">
                <input type="password" id="reauth-password" placeholder="Sua senha" required autocomplete="current-password">
                <div id="reauth-error-message" class="reauth-error-message"></div>
                <div class="timeout-modal-buttons">
                    <button type="submit" id="btn-confirm-reauth" class="timeout-modal-btn btn-confirm-reauth">
                        <span class="btn-text">Continuar</span>
                        <i class="fas fa-spinner fa-spin btn-spinner"></i>
                    </button>
                </div>
            </form>
            <button id="btn-logout-reauth" class="timeout-modal-btn btn-logout-reauth">Sair e fazer login</button>
        </div>
    </div>
</div>

<script>
'use strict';

// --- VARIÁVEIS GLOBAIS ---
let mainSessionTimer;
const timeoutDuration = {{ session_timeout_seconds }};

const modalOverlay = document.getElementById('session-timeout-modal-overlay');
const passwordInput = document.getElementById('reauth-password');
const errorMessage = document.getElementById('reauth-error-message');
const btnConfirm = document.getElementById('btn-confirm-reauth');
const btnLogout = document.getElementById('btn-logout-reauth');
const btnConfirmText = btnConfirm.querySelector('.btn-text');
const btnConfirmSpinner = btnConfirm.querySelector('.btn-spinner');

// --- FUNÇÕES ---

function redirectToLogin() {
    window.location.href = "{% url 'login' %}?motivo=sessao_expirada";
}

function hideWarningModal() {
    modalOverlay.classList.remove('active');
    passwordInput.value = '';
    errorMessage.style.display = 'none';
    btnConfirm.disabled = false;
    btnConfirmText.style.display = 'inline';
    btnConfirmSpinner.style.display = 'none';
}

async function showWarningModal() {
    try {
        const response = await fetch("{% url 'api_keep_alive' %}");
        if (!response.ok) throw new Error('A sessão já expirou no servidor.');
        
        modalOverlay.classList.add('active');
        setTimeout(() => passwordInput.focus(), 100);

    } catch (error) {
        console.error("Não foi possível criar a janela de tolerância:", error);
        redirectToLogin();
    }
}

async function handleReauthentication(event) {
    event.preventDefault();
    const password = passwordInput.value;
    
    if (!password) {
        errorMessage.textContent = 'Por favor, insira sua senha.';
        errorMessage.style.display = 'block';
        return;
    }

    btnConfirm.disabled = true;
    btnConfirmText.style.display = 'none';
    btnConfirmSpinner.style.display = 'inline-block';
    errorMessage.style.display = 'none';

    try {
        const response = await fetch("{% url 'api_reauthenticate' %}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ password: password })
        });

        if (response.ok) {
            hideWarningModal();
            resetMainSessionTimer();
        } else {
            const data = await response.json();
            const serverError = data.error || 'Ocorreu um erro.';
            // AQUI ESTÁ A MUDANÇA NA MENSAGEM DE ERRO
            errorMessage.textContent = `${serverError} Você será redirecionado para a tela de login.`;
            errorMessage.style.display = 'block';
            
            // Trava o botão e aguarda 3 segundos para o usuário ler antes de redirecionar
            btnConfirm.textContent = 'Senha Incorreta';
            setTimeout(redirectToLogin, 3000); 
        }
    } catch (error) {
        console.error("Erro na reautenticação:", error);
        redirectToLogin();
    }
}

function startMainSessionTimer() {
    clearTimeout(mainSessionTimer);
    mainSessionTimer = setTimeout(showWarningModal, timeoutDuration);
}

function resetMainSessionTimer() {
    startMainSessionTimer();
}

function initializeSessionTimeout() {
    if (typeof timeoutDuration !== 'number' || timeoutDuration <= 0) return;

    const activityEvents = ['mousemove', 'mousedown', 'keypress', 'touchmove', 'scroll'];
    activityEvents.forEach(event => document.addEventListener(event, resetMainSessionTimer, { passive: true }));

    btnLogout.addEventListener('click', redirectToLogin);

    startMainSessionTimer();
}

window.addEventListener('load', initializeSessionTimeout);

</script>
{% endif %}